<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>title</title>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <link rel="manifest" id="my-manifest-placeholder" />
  </head>
  <body>
    <img width="512" height="512" />
    <button class="install_btn" hidden>Install</button>

    <script>
      const toBase64 = file =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });

      $(document).ready(function() {
        if ("serviceWorker" in navigator) {
          console.log("Will the service worker register?");
          navigator.serviceWorker
            .register("service-worker.js")
            .then(function(reg) {
              console.log("Yes, it did.");
            })
            .catch(function(err) {
              console.log("No it didn't. This happened:", err);
            });
        }
        const urlParams = new URLSearchParams(window.location.search);
        const imageUrl = urlParams.get("image").split("?")[0];

        var r,
          l = document.querySelector(".install_btn");
        window.addEventListener("beforeinstallprompt", function(e) {
          e.preventDefault(), (r = e);
          l.hidden = !1;
        }),
          (installApp = function() {
            r.prompt(),
              (l.hidden = !0),
              r.userChoice.then(function(e) {
                "accepted" === e.outcome
                  ? console.log("User accepted the A2HS prompt")
                  : console.log("User dismissed the A2HS prompt"),
                  (r = null);
              });
          });

        l.addEventListener("click", installApp, !1);

        if (!imageUrl) return;
        $("img").attr("src", imageUrl);
        (async function(e) {
          var myDynamicManifest = {
            name: "IEC",
            short_name: "IEC",
            description: "Something dynamic",
            start_url: "https://" + location.host,
            background_color: "#000000",
            theme_color: "#0f4a73",
            display: "standalone",
            icons: [
              {
                src: imageUrl,
                sizes: "512x512",
                type: "image/png"
              }
            ]
          };
          const stringManifest = JSON.stringify(myDynamicManifest);
          const blob = new Blob([stringManifest], { type: "application/json" });
          const manifestURL = await toBase64(blob);

          document
            .querySelector("#my-manifest-placeholder")
            .setAttribute("href", manifestURL);
        })();
      });
    </script>
  </body>
</html>
